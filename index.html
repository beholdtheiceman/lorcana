<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lorcana Card Image Browser</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f8fafc; color: #0f172a; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .header h1 { margin: 0 0 6px; font-size: 26px; }
    .muted { color: #64748b; font-size: 14px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 8px 0 16px; }
    input[type="text"], select, button, input[type="url"] {
      padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 10px; background:#fff; box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    input[type="text"]{ flex: 1 1 360px; min-width: 260px; }
    input[readonly]{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; }
    figure { margin: 0; background:#fff; border:1px solid #e2e8f0; border-radius: 14px; overflow: hidden; cursor: pointer; transition: box-shadow .15s; }
    figure:hover{ box-shadow: 0 6px 16px rgba(2,6,23,0.08); }
    figcaption { padding: 8px 10px; }
    .title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sub { color:#64748b; font-size: 12px; }
    .badge { display:inline-block; font-size: 10px; color:#334155; background:#e2e8f0; padding:2px 6px; border-radius:999px; margin-left:6px; vertical-align: middle; }
    .preview { position: fixed; right: 12px; bottom: 12px; background: rgba(255,255,255,.92); border:1px solid #e2e8f0; border-radius: 14px; padding: 8px; display:flex; gap:8px; align-items: center; box-shadow: 0 6px 18px rgba(2,6,23,0.12); }
    .preview img { width: 56px; border-radius: 8px; }
    .btn { cursor:pointer; }
    .error { color:#dc2626; font-weight:600; }
    html.overlay, body.overlay { height:100%; background: transparent; }
    .wrap { width:100vw; height:100vh; display:grid; place-items:center; }
    .fade-in { opacity: 0; transition: opacity .2s ease-in; }
    .fade-in.loaded { opacity: 1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React UMD (no JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- App (no Babel, no JSX) -->
  <script>
    (function () {
      const { useState, useEffect, useMemo, useRef } = React;
      const h = React.createElement;

      // ===== Firebase config =====
      var FIREBASE_CONFIG = {
        apiKey: "AIzaSyDkXEhCduyXpXRUqbUFIuFIUHWiQbVZ9Kw",
        authDomain: "lorcana-efc7a.firebaseapp.com",
        databaseURL: "https://lorcana-efc7a-default-rtdb.firebaseio.com",
        projectId: "lorcana-efc7a",
        storageBucket: "lorcana-efc7a.firebasestorage.app",
        messagingSenderId: "634624437266",
        appId: "1:634624437266:web:8c8c4ad2d461e3d7567ccb",
        measurementId: "G-MBJ0ZJFR2W"
      };
      function initFirebase(){
        try { return firebase.database(firebase.initializeApp(FIREBASE_CONFIG)); }
        catch(e){ try { return firebase.database(); } catch(e2){ return null; } }
      }

      // ===== Instance + storage keys =====
      const params = new URLSearchParams(window.location.search);
      const INSTANCE = (params.get("inst") || "default").trim();
      function k(name){ return "lorcana:"+INSTANCE+":"+name; } // local/session

      // ===== Utils =====
      function useDebounced(value, delay){
        if (delay === void 0) delay = 400;
        const [v,setV] = useState(value);
        useEffect(function(){ const t=setTimeout(function(){ setV(value); }, delay); return function(){ clearTimeout(t); }; }, [value, delay]);
        return v;
      }
      function buildOverlayUrl(){
        const url = new URL(window.location.href);
        url.searchParams.set("overlay","1");
        url.searchParams.set("inst", INSTANCE);
        url.searchParams.set("c", INSTANCE); // force channel = instance
        return url.toString();
      }

      // ===== Data fetching =====
      function mapFromLorcanaAPI(item){
        if(!item) return null;
        var img = item.Image || item.image || item.ImageUrl || item.ImageURL ||
                  (item.Images && (item.Images.Full || item.Images.full || item.Images.Normal));
        var setName = item.Set_Name || item.Set || item.set_name || item.setName || "";
        var number = item.Number || item.number || item.Collector_Number || item.collector_number || "";
        var id = (item.ID || item.Id || item.id || ((item.Name || item.name)+"-"+number+"-"+setName)).toString();
        return img ? {
          id: id,
          name: item.Name || item.name || "",
          set: setName,
          number: number,
          image_url: img,
          _source: "Lorcana-API.com",
          _raw: item
        } : null;
      }
      function mapFromLorcast(item){
        if(!item) return null;
        var dig = item.image_uris && item.image_uris.digital;
        var fullUrl = (dig && dig.large) ? dig.large.replace('/large/', '/full/').replace('.avif', '.jpg') : '';
        var img = fullUrl || (dig && (dig.large || dig.normal || dig.small)) || "";
        var setName = (item.set && item.set.name) || "";
        var number = item.collector_number || item.number || "";
        var id = (item.id || (item.name+"-"+number+"-"+setName)).toString();
        return img ? { id:id, name:item.name||"", set:setName, number:number, image_url:img, _source:"Lorcast", _raw:item } : null;
      }
      async function fetchFromLorcanaAPI(query){
        try {
          var url = new URL("https://api.lorcana-api.com/cards/fetch");
          url.searchParams.set("search", query || "");
          var res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
          if(!res.ok) throw 0;
          var data = await res.json();
          var arr = Array.isArray(data) ? data : ((data && Array.isArray(data.cards)) ? data.cards : []);
          var out = [];
          for (var i=0;i<arr.length;i++){ var m=mapFromLorcanaAPI(arr[i]); if(m) out.push(m); }
          return out;
        } catch(e){ return []; }
      }
      async function fetchFromLorcast(query){
        try {
          var url = new URL("https://api.lorcast.com/v0/cards/search");
          url.searchParams.set("q", query || "");
          var res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
          if(!res.ok) throw 0;
          var data = await res.json();
          var arr = (data && Array.isArray(data.results)) ? data.results : [];
          var out = [];
          for (var i=0;i<arr.length;i++){ var m=mapFromLorcast(arr[i]); if(m) out.push(m); }
          return out;
        } catch(e){ return []; }
      }
      async function searchCards(query){
        if(!query) return [];
        var primary = await fetchFromLorcanaAPI(query);
        if(primary && primary.length) return primary;
        return await fetchFromLorcast(query);
      }

      // ===== Components =====
      function App(){
        const overlayMode = params.get("overlay") === "1";
        if (overlayMode) {
          document.documentElement.classList.add("overlay");
          document.body.classList.add("overlay");
          return h(Overlay);
        }
        return h(Controller);
      }

      function Controller(){
        const [query,setQuery]     = useState("");
        const [cards,setCards]     = useState([]);
        const [loading,setLoading] = useState(false);
        const [error,setError]     = useState("");
        const [selected,setSel]    = useState(null);
        const [copyMsg,setCopyMsg] = useState("");

        const db = useMemo(initFirebase, []);
        const debounced = useDebounced(query, 350);
        const overlayUrl = useMemo(buildOverlayUrl, []);
        const urlInputRef = useRef(null);

        useEffect(function(){
          try{
            const q  = sessionStorage.getItem(k("lastQuery"));
            const rs = sessionStorage.getItem(k("lastResults"));
            if(q) setQuery(q);
            if(rs) setCards(JSON.parse(rs));
          }catch(e){}
        },[]);

        useEffect(function(){
          const controller = new AbortController();
          async function run(){
            setError("");
            if(!debounced){ setCards([]); return; }
            setLoading(true);
            try{
              const results = await searchCards(debounced);
              setCards(results);
              try{
                sessionStorage.setItem(k("lastResults"), JSON.stringify(results));
                sessionStorage.setItem(k("lastQuery"), debounced);
              }catch(e){}
            }catch(e){
              if(e && e.name === "AbortError") return;
              setError((e && e.message) || "Something went wrong");
            }finally{ setLoading(false); }
          }
          run();
          return function(){ controller.abort(); };
        }, [debounced]);

        useEffect(function(){
          const imgs = cards.slice(0,60).map(function (c){ return c && c.image_url; }).filter(Boolean);
          imgs.forEach(function(src){ var img=new Image(); img.src=src; });
        }, [cards]);

        function pushSelection(card){
          setSel(card);
          var src = (card && card.image_url) || "";
          var payload = { image: src, title: card ? card.name : "", updatedAt: Date.now() };
          try {
            localStorage.setItem(k("overlayPayload"), JSON.stringify(payload));
            localStorage.setItem(k("overlayUpdatedAt"), String(payload.updatedAt));
          } catch(e){}
          if(db){
            try { db.ref("/lorcana/" + INSTANCE).set(payload); } catch(e){ console.error(e); }
          }
        }

        function clearSelection(){
          setSel(null);
          const payload = { image:"", title:"", updatedAt: Date.now() };
          try {
            localStorage.setItem(k("overlayPayload"), JSON.stringify(payload));
            localStorage.setItem(k("overlayUpdatedAt"), String(payload.updatedAt));
          } catch(e){}
          if(db){
            try { db.ref("/lorcana/" + INSTANCE).set(payload); } catch(e){ console.error(e); }
          }
        }

        async function copyOverlayUrl(){
          const text = overlayUrl; setCopyMsg("");
          try{
            if(navigator.clipboard && typeof navigator.clipboard.writeText === "function"){
              await navigator.clipboard.writeText(text);
              setCopyMsg("Copied"); setTimeout(function(){ setCopyMsg(""); }, 1500); return;
            }
            throw new Error("Clipboard API unavailable");
          }catch(e){
            try{
              if(urlInputRef.current){ urlInputRef.current.focus(); urlInputRef.current.select(); document.execCommand && document.execCommand("copy"); }
            }catch(e2){}
            setCopyMsg("Press Ctrl+C (Cmd+C on Mac)"); setTimeout(function(){ setCopyMsg(""); }, 2500);
          }
        }

        return h("div", { className:"container" },
          h("div", { className:"header" },
            h("h1", null, "Lorcana Card Image Browser"),
            h("div", { className:"muted" }, "Instance: ", h("strong", null, INSTANCE), " · Channel auto-locked to instance")
          ),
          h("div", { className:"row" },
            h("input", {
              type:"text",
              placeholder:"Search by name, type, text, ink, rarity...",
              value: query,
              onChange: function(e){ setQuery(e.target.value); }
            })
          ),
          h("div", { className:"row" },
            h("label", { className:"muted" }, "Overlay URL:"),
            h("input", {
              ref: urlInputRef,
              type:"url",
              value: overlayUrl,
              readOnly: true,
              onFocus: function(e){ e.currentTarget.select(); },
              style: { flex:"1 1 auto", minWidth:"300px" }
            }),
            h("button", { className:"btn", onClick: copyOverlayUrl }, "Copy"),
            h("button", { className:"btn", style:{ marginLeft:"8px" }, onClick: clearSelection }, "Clear Overlay"),
            copyMsg ? h("span", { className:"muted" }, copyMsg) : null
          ),
          loading ? h("div", { className:"muted" }, "Searching...") : null,
          error ? h("div", { className:"error" }, error) : null,
          h("div", { className:"grid" },
            (cards||[]).map(function(card){
              return h("figure", {
                  key: card.id,
                  role:"button",
                  tabIndex:0,
                  "aria-label":"Select "+(card.name||"")+" for overlay",
                  onClick: function(){ pushSelection(card); },
                  onKeyDown: function(e){ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); pushSelection(card); } }
                },
                card.image_url
                  ? h("img", { src: card.image_url, alt: card.name||"", style:{ width:"100%", display:"block" }, loading:"lazy" })
                  : h("div", { style:{ aspectRatio:"146/204", display:"grid", placeItems:"center", color:"#94a3b8" } }, "No image"),
                h("figcaption", null,
                  h("div", { className:"title" },
                    card.name,
                    card._source ? h("span", { className:"badge" }, card._source) : null
                  ),
                  h("div", { className:"sub" }, (card.set||"Unknown Set"), " · #", (card.number||"?"))
                )
              );
            })
          ),
          selected ? h("div", { className:"preview" },
            selected.image_url ? h("img", { src:selected.image_url, alt:"preview" }) : null,
            h("div", null,
              h("div", { className:"title", style:{ maxWidth:"220px" } }, selected.name),
              h("div", { className:"sub" }, "Sent to overlay")
            )
          ) : null
        );
      }

      function Overlay(){
        const [src,setSrc] = useState("");
        const [title,setTitle] = useState("");
        const [stamp,setStamp] = useState("");
        const [loaded,setLoaded] = useState(false);
        const db = useMemo(initFirebase, []);

        function applyPayload(payload){
          if(!payload || !payload.image){
            setSrc(""); setTitle(""); setLoaded(true); return;
          }
          var newSrc = payload.image;
          var newTitle = payload.title || "";
          var img = new Image();
          img.onload = function(){
            setSrc(newSrc); setTitle(newTitle);
            setLoaded(false); setTimeout(function(){ setLoaded(true); }, 0);
          };
          img.onerror = function(){};
          img.src = newSrc;
        }

        useEffect(function(){
          try {
            var raw = localStorage.getItem(k("overlayPayload"));
            var payload = null;
            try { payload = raw ? JSON.parse(raw) : null; } catch(e){}
            if(payload && typeof payload.updatedAt !== "undefined"){
              setStamp(String(payload.updatedAt||""));
              applyPayload(payload);
            } else {
              var st = localStorage.getItem(k("overlayUpdatedAt")) || "";
              if(st) setStamp(st);
            }
          } catch(e){}
        }, []);

        useEffect(function(){
          if(!db) return;
          var ref = db.ref("/lorcana/" + INSTANCE);
          var unsub = ref.on("value", function(snap){
            var v = snap.val() || {};
            if(v && v.updatedAt && String(v.updatedAt) !== String(stamp)){
              setStamp(String(v.updatedAt));
              applyPayload(v);
            } else if (v && !v.image){
              setStamp(String(v.updatedAt||""));
              applyPayload(v);
            }
          });
          return function(){ try { ref.off("value", unsub); } catch(e){} };
        }, [db, stamp]);

        useEffect(function(){
          var t = setInterval(function(){
            try{
              var s = localStorage.getItem(k("overlayUpdatedAt")) || "";
              if(s !== stamp){
                var raw = localStorage.getItem(k("overlayPayload"));
                var payload = null;
                try { payload = raw ? JSON.parse(raw) : null; } catch(e){}
                if(payload && payload.updatedAt && String(payload.updatedAt) === String(s)){
                  setStamp(String(s));
                  applyPayload(payload);
                }
              }
            }catch(e){}
          }, 1000);
          return function(){ clearInterval(t); };
        }, [stamp]);

        return h("div", { className:"wrap" },
          src ? h("img", {
            src: src, alt: title,
            className: "fade-in"+(loaded?" loaded":""),
            style: { maxWidth:"100%", maxHeight:"100%", objectFit:"contain" }
          }) : null
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(h(App));
    })();
  </script>
</body>
</html>
