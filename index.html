<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lorcana Card Image Browser</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f8fafc; color: #0f172a; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .header h1 { margin: 0 0 6px; font-size: 26px; }
    .muted { color: #64748b; font-size: 14px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 8px 0 16px; }
    input[type="text"], select, button, input[type="url"] {
      padding: 8px 10px; border: 1px solid #cbd5e1; border-radius: 10px; background:#fff; box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    input[type="text"]{ flex: 1 1 360px; min-width: 260px; }
    input[readonly]{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; }
    figure { margin: 0; background:#fff; border:1px solid #e2e8f0; border-radius: 14px; overflow: hidden; cursor: pointer; transition: box-shadow .15s; }
    figure:hover{ box-shadow: 0 6px 16px rgba(2,6,23,0.08); }
    figcaption { padding: 8px 10px; }
    .title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sub { color:#64748b; font-size: 12px; }
    .badge { display:inline-block; font-size: 10px; color:#334155; background:#e2e8f0; padding:2px 6px; border-radius:999px; margin-left:6px; vertical-align: middle; }
    .preview { position: fixed; right: 12px; bottom: 12px; background: rgba(255,255,255,.92); border:1px solid #e2e8f0; border-radius: 14px; padding: 8px; display:flex; gap:8px; align-items: center; box-shadow: 0 6px 18px rgba(2,6,23,0.12); }
    .preview img { width: 56px; border-radius: 8px; }
    .btn { cursor:pointer; }
    .switch { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; }
    .error { color:#dc2626; font-weight:600; }
    html.overlay, body.overlay { height:100%; background: transparent; }
    .wrap { width:100vw; height:100vh; display:grid; place-items:center; }
    .fade-in { opacity: 0; transition: opacity .2s ease-in; }
    .fade-in.loaded { opacity: 1; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useMemo, useRef } = React;

    var FIREBASE_CONFIG = {
      apiKey: "AIzaSyDkXEhCduyXpXRUqbUFIuFIUHWiQbVZ9Kw",
      authDomain: "lorcana-efc7a.firebaseapp.com",
      databaseURL: "https://lorcana-efc7a-default-rtdb.firebaseio.com",
      projectId: "lorcana-efc7a",
      storageBucket: "lorcana-efc7a.firebasestorage.app",
      messagingSenderId: "634624437266",
      appId: "1:634624437266:web:8c8c4ad2d461e3d7567ccb",
      measurementId: "G-MBJ0ZJFR2W"
    };

    function initFirebase(){ try{ return firebase.database(firebase.initializeApp(FIREBASE_CONFIG)); }catch(e){ return firebase.database(); } }

    const params = new URLSearchParams(window.location.search);
    const INSTANCE = params.get("inst") || "default";
    const k = name => `lorcana:${INSTANCE}:${name}`;
    const sk = name => `lorcana:${INSTANCE}:${name}`;

    function useDebounced(v, d=400){ const[s,setS]=useState(v); useEffect(()=>{const t=setTimeout(()=>setS(v),d); return()=>clearTimeout(t)},[v]); return s; }

    function buildOverlayUrl(){
      const url = new URL(window.location.href);
      url.searchParams.set("overlay","1");
      url.searchParams.set("inst",INSTANCE);
      url.searchParams.set("c",INSTANCE);
      return url.toString();
    }

    async function fetchA(q){
      try{
        var u=new URL("https://api.lorcana-api.com/cards/fetch");
        u.searchParams.set("search",q);
        var r=await fetch(u); if(!r.ok)throw 0;
        var d=await r.json(); d=Array.isArray(d)?d:(d.cards||[]);
        return d.map(x=>({
          id:x.id||x.Name+x.Number,
          name:x.Name, set:x.Set_Name, number:x.Number,
          image_url:x.Image || (x.Images&&x.Images.Full)
        })).filter(x=>x.image_url);
      }catch(e){ return []; }
    }

    async function fetchB(q){
      try{
        var u=new URL("https://api.lorcast.com/v0/cards/search");
        u.searchParams.set("q",q);
        var r=await fetch(u); if(!r.ok)throw 0;
        var d=await r.json(); d=d.results||[];
        return d.map(x=>({
          id:x.id, name:x.name, set:x.set?.name, number:x.collector_number,
          image_url:x.image_uris?.digital?.normal
        })).filter(x=>x.image_url);
      }catch(e){ return []; }
    }

    async function searchCards(q){
      if(!q)return[];
      var a = await fetchA(q);
      return a.length?a:(await fetchB(q));
    }

    function App(){
      return params.get("overlay")==="1" ? <Overlay/> : <Controller/>;
    }

    function Controller(){
      const [query,setQuery]=useState("");
      const [cards,setCards]=useState([]);
      const [loading,setLoading]=useState(false);
      const [sel,setSel]=useState(null);
      const [lock,setLock]=useState(true);
      const deb=useDebounced(query);
      const db=useMemo(initFirebase,[]);
      const channel = INSTANCE;
      const overlayUrl = buildOverlayUrl();

      useEffect(()=>{
        async function run(){
          if(!deb){setCards([]);return;}
          setLoading(true);
          const r=await searchCards(deb);
          setCards(r);
          setLoading(false);
        }
        run();
      },[deb]);

      function push(card){
        setSel(card);
        const payload = { image:card.image_url, title:card.name, updatedAt:Date.now() };
        localStorage.setItem(k("overlayPayload"),JSON.stringify(payload));
        localStorage.setItem(k("overlayUpdatedAt"),payload.updatedAt);
        db.ref("/lorcana/"+channel).set(payload);
      }

      function clear(){
        setSel(null);
        const p={image:"",title:"",updatedAt:Date.now()};
        localStorage.setItem(k("overlayPayload"),JSON.stringify(p));
        localStorage.setItem(k("overlayUpdatedAt"),p.updatedAt);
        db.ref("/lorcana/"+channel).set(p);
      }

      return (
        <div className="container">
          <h1>Lorcana Card Browser</h1>
          <div className="muted">Instance: <b>{INSTANCE}</b> · Channel auto-locked</div>

          <div className="row">
            <input placeholder="Search cards..." value={query} onChange={e=>setQuery(e.target.value)} />
          </div>

          <div className="row">
            <label>Overlay URL:</label>
            <input value={overlayUrl} readOnly style={{flex:"1 1 auto"}} />
            <button onClick={()=>navigator.clipboard.writeText(overlayUrl)}>Copy</button>
            <button onClick={clear}>Clear Overlay</button>
          </div>

          {loading && <div className="muted">Searching…</div>}

          <div className="grid">
            {cards.map(c=>(
              <figure key={c.id} onClick={()=>push(c)}>
                <img src={c.image_url} style={{width:"100%"}} />
                <figcaption>
                  <div className="title">{c.name}</div>
                  <div className="sub">{c.set} · #{c.number}</div>
                </figcaption>
              </figure>
            ))}
          </div>

          {sel && (
            <div className="preview">
              <img src={sel.image_url} />
              <div><b>{sel.name}</b><br/><span className="sub">Sent to overlay</span></div>
            </div>
          )}
        </div>
      );
    }

    function Overlay(){
      const [src,setSrc]=useState("");
      const [stamp,setStamp]=useState("");
      const db=useMemo(initFirebase,[]);
      const channel = INSTANCE;

      useEffect(()=>{
        const raw = localStorage.getItem(k("overlayPayload"));
        if(raw){
          const p=JSON.parse(raw);
          if(p.image) setSrc(p.image);
          setStamp(p.updatedAt||"");
        }
      },[]);

      useEffect(()=>{
        db.ref("/lorcana/"+channel).on("value",snap=>{
          const v=snap.val()||{};
          if(v.updatedAt!==stamp){
            setStamp(v.updatedAt);
            setSrc(v.image||"");
          }
        });
      },[]);

      return (
        <div className="wrap">
          {src ? <img src={src} className="fade-in loaded" style={{maxWidth:"100%",maxHeight:"100%"}} /> : null}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
